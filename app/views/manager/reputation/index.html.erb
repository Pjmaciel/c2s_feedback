<div class="max-w-3xl mx-auto">
  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Monitoramento de Reputação</h1>
      <%= link_to 'Voltar ao Dashboard', manager_dashboard_path,
                  class: 'bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded' %>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <%= form_tag search_manager_reputation_index_path, method: :get, class: "space-y-4", data: { turbo: false } do %>
        <div>
          <%= label_tag :company_name, "Nome da Empresa", class: "block text-sm font-medium text-gray-700" %>
          <%= text_field_tag :company_name, params[:company_name], class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
        </div>
        <%= submit_tag "Pesquisar", class: "w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700" %>
      <% end %>
    </div>

    <div id="company-info" class="bg-white rounded-lg shadow p-6 mb-8 hidden">
      <h2 class="text-xl font-bold mb-4" id="company-name">Empresa: Aguardando...</h2>
      <div class="grid grid-cols-2 gap-6">
        <div>
          <h3 class="text-sm font-medium text-gray-500">Índice de Solução</h3>
          <p class="mt-1 text-2xl font-semibold" id="solution-index">Aguardando...</p>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-500">Nota de Reputação</h3>
          <p class="mt-1 text-2xl font-semibold" id="reputation-score">Aguardando...</p>
        </div>
      </div>
      <div class="mt-4">
        <a id="reputation-link" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 hidden">Ver no ReclameAqui</a>
      </div>
    </div>

    <%= render 'manager/reputation/recent_searches', recent_searches: @recent_searches if @recent_searches.present? %>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let channel = consumer.subscriptions.create(
            { channel: "ReputationChannel", user_id: window.currentUserId },
            {
                received(data) {
                    console.log("Dados recebidos via WebSocket:", data);

                    document.getElementById("company-info").classList.remove("hidden");

                    if (data.status === "Erro ao buscar dados.") {
                        document.getElementById("company-name").textContent = "Erro ao buscar dados.";
                        return;
                    }

                    document.getElementById("company-name").textContent = data.company_name;
                    document.getElementById("solution-index").textContent = data.solution_rate;
                    document.getElementById("reputation-score").textContent = data.reputation_score;

                    let link = document.getElementById("reputation-link");
                    link.href = `https://www.reclameaqui.com.br/empresa/${data.company_name.toLowerCase()}`;
                    link.classList.remove("hidden");
                },
            }
        );
    });
</script>
